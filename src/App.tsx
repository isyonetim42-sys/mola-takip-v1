// @ts-nocheck
import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  doc, 
  serverTimestamp,
  deleteDoc,
  updateDoc,
  setDoc
} from 'firebase/firestore';
import { 
  Clock, Users, LogOut, AlertTriangle, 
  Coffee, Utensils, UserPlus, Trash2, ShieldAlert, 
  Droplets, Crown, Shield, UserCog, Activity, FileText, Filter, Save, Settings,
  Palette, Lock, ToggleLeft, ToggleRight, MapPin, Star, Flag, Edit,
  Wifi, Construction, ChevronDown, X, Eye, EyeOff, 
  MoreVertical, Timer, QrCode, Scan
} from 'lucide-react';

// --- FIREBASE AYARLARI (BURAYI DOLDUR) ---
const firebaseConfig = {
  apiKey: "AIzaSyCyiErvh_XsbH1XVW42II1I7HWp9HxknKc",
  authDomain: "mola-takip-42.firebaseapp.com",
  projectId: "mola-takip-42",
  storageBucket: "mola-takip-42.firebasestorage.app",
  messagingSenderId: "891888864128",
  appId: "1:891888864128:web:e410ae889c62493c0d0f65",
  measurementId: "G-MPZ853D3JS"
};



// Hata önleyici başlatma
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = 'magaza-mola-v1';

// --- YARDIMCI FONKSİYONLAR ---
const deduplicateById = (items) => {
  const uniqueMap = new Map();
  items.forEach(item => { if (item.id) uniqueMap.set(item.id, item); });
  return Array.from(uniqueMap.values());
};

const formatTime = (d) => { try { const date = d?.toDate ? d.toDate() : new Date(d); if(isNaN(date.getTime())) return '--:--'; return date.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}); } catch(e){return '--:--'} };
const formatDate = (d) => { try { const date = d?.toDate ? d.toDate() : new Date(d); if(isNaN(date.getTime())) return '-'; return date.toLocaleDateString('tr-TR'); } catch(e){return '-'} };
const getSecondsDiff = (s, e=new Date()) => { try { const start = s?.toDate ? s.toDate() : new Date(s); const end = e && e.toDate ? e.toDate() : (e?new Date(e):new Date()); if(isNaN(start.getTime()) || isNaN(end.getTime())) return 0; return Math.floor((end-start)/1000); } catch(r){return 0} };
const formatDuration = (sec) => { if (isNaN(sec)) return "0 dk"; return `${Math.floor(sec/60)} dk ${sec%60} sn`; };
const getClientIP = async () => { try { const res = await fetch('https://api.ipify.org?format=json'); const data = await res.json(); return data.ip; } catch (e) { return null; } };

// --- SABİTLER ---
const CARD_COLORS = [ "bg-slate-800 border-slate-600", "bg-blue-900/40 border-blue-700", "bg-emerald-900/40 border-emerald-700", "bg-purple-900/40 border-purple-700", "bg-rose-900/40 border-rose-700", "bg-amber-900/40 border-amber-700", "bg-indigo-900/40 border-indigo-700", "bg-cyan-900/40 border-cyan-700"];
const DEPT_STYLES = { "Bayan Ayakkabı": "bg-pink-900/40 text-pink-200 border-pink-700", "Erkek Ayakkabı": "bg-blue-900/40 text-blue-200 border-blue-700", "Bayan Tekstil": "bg-purple-900/40 text-purple-200 border-purple-700", "Erkek Tekstil": "bg-indigo-900/40 text-indigo-200 border-indigo-700", "Kasa": "bg-emerald-900/40 text-emerald-200 border-emerald-700", "Depo": "bg-orange-900/40 text-orange-200 border-orange-700", "Güvenlik": "bg-slate-700/50 text-slate-200 border-slate-500", "Yönetim": "bg-white/10 text-white border-white/20" };
const DEPARTMENTS = Object.keys(DEPT_STYLES).filter(d => d !== 'Yönetim');
const ROLES = { FOUNDER: 'kurucu', MANAGER: 'mudur', ASST_MANAGER: 'mudur_yrd', STAFF: 'personel', OBSERVER: 'gozlemci', DEFAULT: 'Default' };
const ROLE_LABELS = { [ROLES.FOUNDER]: 'KURUCU', [ROLES.MANAGER]: 'MÜDÜR', [ROLES.ASST_MANAGER]: 'MÜDÜR YRD.', [ROLES.STAFF]: 'Personel', [ROLES.OBSERVER]: 'Gözlemci', [ROLES.DEFAULT]: 'Default' };
const HIERARCHY = { [ROLES.FOUNDER]: 5, [ROLES.MANAGER]: 4, [ROLES.ASST_MANAGER]: 3, [ROLES.OBSERVER]: 2, [ROLES.STAFF]: 1, [ROLES.DEFAULT]: 0 };
const ROLE_STYLES = { [ROLES.FOUNDER]: 'bg-yellow-500/20 text-yellow-200 border-yellow-600', [ROLES.MANAGER]: 'bg-blue-500/20 text-blue-200 border-blue-600', [ROLES.ASST_MANAGER]: 'bg-cyan-500/20 text-cyan-200 border-cyan-600', [ROLES.OBSERVER]: 'bg-green-500/20 text-green-200 border-green-600', [ROLES.STAFF]: 'bg-slate-700/30 text-slate-300 border-slate-600', [ROLES.DEFAULT]: 'bg-zinc-800 text-zinc-500 border-zinc-700 grayscale opacity-60' };
const STANDARD_BREAKS = [ { id: 'cay1', label: '1. Çay Molası', duration: 15 }, { id: 'yemek', label: 'Yemek Molası', duration: 40 }, { id: 'cay2', label: '2. Çay Molası', duration: 15 }, { id: 'cay3', label: '3. Çay Molası', duration: 15 } ];
const THEME_CATALOG = [ { id: 'slate', name: 'Kurumsal Koyu', class: 'bg-slate-900 text-slate-300', accent: 'blue' }, { id: 'midnight', name: 'Gece Mavisi', class: 'bg-[#0f172a] text-blue-200', accent: 'indigo' }, { id: 'pure_black', name: 'Tam Siyah', class: 'bg-black text-gray-400', accent: 'zinc' }, { id: 'black_glass', name: 'Siyah Şeffaf', class: 'bg-black/90 backdrop-blur-xl text-gray-300', accent: 'slate' } ];
const STAFF_THEMES = [ { bg: "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=1000", quote: "Başarı, her gün tekrarlanan küçük çabaların toplamıdır." }, { bg: "https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=1000", quote: "Kalite bir eylem değil, bir alışkanlıktır." } ];
const getSpecialDayTheme = () => { return { id: 'default', bg: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564', overlay: 'bg-black/50', title: 'Mola Takip', subTitle: 'Personel Giriş Portalı', icon: <Users className="w-12 h-12 text-white" />, btnClass: 'bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white' }; };
const DEFAULT_SETTINGS = { permissions: { [ROLES.MANAGER]: { canManageStaff: true, canDeleteBreaks: false, canViewReports: true, canAccessPanel: true }, [ROLES.ASST_MANAGER]: { canManageStaff: true, canDeleteBreaks: false, canViewReports: true, canAccessPanel: true }, [ROLES.OBSERVER]: { canManageStaff: false, canDeleteBreaks: false, canViewReports: false, canAccessPanel: false }, [ROLES.STAFF]: { canManageStaff: false, canDeleteBreaks: false, canViewReports: false, canAccessPanel: false } }, theme: 'slate', maintenanceMode: false, security: { locationEnabled: false, ipCheckEnabled: false, allowedIP: '', storePassword: '' } };

export default function App() {
  const [user, setUser] = useState(null);
  const [appUser, setAppUser] = useState(null);
  const [view, setView] = useState('login');
  const [adminTab, setAdminTab] = useState('dashboard');
  const [users, setUsers] = useState([]);
  const [activeBreaks, setActiveBreaks] = useState([]);
  const [breakHistory, setBreakHistory] = useState([]);
  const [systemSettings, setSystemSettings] = useState(DEFAULT_SETTINGS);
  const [currentTime, setCurrentTime] = useState(new Date());
  const [staffTheme, setStaffTheme] = useState(STAFF_THEMES[0]);
  const [locLoading, setLocLoading] = useState(false);
  const [specialTheme] = useState(getSpecialDayTheme());
  const [permRole, setPermRole] = useState(ROLES.MANAGER);
  const [extraTimeModal, setExtraTimeModal] = useState({ show: false, userId: null, userName: '' });
  const [manualExtraTime, setManualExtraTime] = useState('');
  const [qrInput, setQrInput] = useState('');
  const [scanning, setScanning] = useState(false);
  const videoRef = useRef(null);
  const [loginCode, setLoginCode] = useState('');
  const [loginPass, setLoginPass] = useState('');
  const [newUser, setNewUser] = useState({ name: '', code: '', pass: '', dept: DEPARTMENTS[0], role: ROLES.STAFF });
  const [editingUserId, setEditingUserId] = useState(null);
  const [filterStart, setFilterStart] = useState('');
  const [filterEnd, setFilterEnd] = useState('');
  const [filterName, setFilterName] = useState('');
  const [filterType, setFilterType] = useState('all');
  const [filterLateOnly, setFilterLateOnly] = useState(false);
  const [errorMsg, setErrorMsg] = useState('');
  const [successMsg, setSuccessMsg] = useState('');
  const [staffFilterRole, setStaffFilterRole] = useState('active_only'); 
  const [loginTab, setLoginTab] = useState('staff');
  const [showStoreAuthModal, setShowStoreAuthModal] = useState(false);
  const [pendingUser, setPendingUser] = useState(null);
  const [showLoginPass, setShowLoginPass] = useState(false);
  const [visiblePasswords, setVisiblePasswords] = useState({});

  useEffect(() => { const initAuth = async () => { await signInAnonymously(auth); }; initAuth(); const unsubAuth = onAuthStateChanged(auth, setUser); const timer = setInterval(() => setCurrentTime(new Date()), 1000); setStaffTheme(STAFF_THEMES[Math.floor(Math.random() * STAFF_THEMES.length)]); return () => { unsubAuth(); clearInterval(timer); }; }, []);
  useEffect(() => { setErrorMsg(''); setSuccessMsg(''); }, [view, adminTab, loginTab]);
  useEffect(() => { if (!user) return; const unsubUsers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (s) => { setUsers(deduplicateById(s.docs.map(d => ({id:d.id, ...d.data()})))) }); const unsubActive = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'activeBreaks'), (s) => setActiveBreaks(deduplicateById(s.docs.map(d => ({id:d.id, ...d.data()}))))); const unsubHistory = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'breakHistory'), (s) => { const h = deduplicateById(s.docs.map(d => ({id:d.id, ...d.data()}))); h.sort((a,b) => (b.endTime?.seconds||0) - (a.endTime?.seconds||0)); setBreakHistory(h); }); const unsubSettings = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'systemSettings', 'main'), (d) => { if(d.exists()) setSystemSettings(d.data()); else setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'systemSettings', 'main'), DEFAULT_SETTINGS); }); return () => { unsubUsers(); unsubActive(); unsubHistory(); unsubSettings(); }; }, [user]);

  const startScanning = async () => { setScanning(true); try { const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); if (videoRef.current) { videoRef.current.srcObject = stream; videoRef.current.play(); scanFrame(); } } catch (err) { setErrorMsg("Kamera açılamadı."); setScanning(false); } };
  const stopScanning = () => { setScanning(false); if (videoRef.current && videoRef.current.srcObject) { videoRef.current.srcObject.getTracks().forEach(track => track.stop()); } };
  const scanFrame = async () => { if (!videoRef.current || !window.BarcodeDetector) return; try { const barcodeDetector = new window.BarcodeDetector({ formats: ['qr_code'] }); const interval = setInterval(async () => { if (!videoRef.current) { clearInterval(interval); return; } try { const barcodes = await barcodeDetector.detect(videoRef.current); if (barcodes.length > 0) { const rawValue = barcodes[0].rawValue; setQrInput(rawValue); stopScanning(); clearInterval(interval); if (rawValue === systemSettings.security.storePassword) { if (showStoreAuthModal) { setAppUser(pendingUser); setLoginCode(''); setLoginPass(''); setPendingUser(null); setShowStoreAuthModal(false); setView('staff'); } setQrInput(''); } else { alert("QR Kod Hatası!"); } } } catch (e) {} }, 500); } catch (e) {} };

  const hasPermission = (role, action) => { if (role === ROLES.FOUNDER) return true; const perms = systemSettings.permissions?.[role]; return perms ? (action === 'canAccessPanel' ? perms.canAccessPanel : perms[action]) : false; };
  const canManageRole = (manager, target) => { if (target === ROLES.FOUNDER && manager !== ROLES.FOUNDER) return false; if (manager === ROLES.FOUNDER) return true; return hasPermission(manager, 'canManageStaff') && HIERARCHY[manager] > HIERARCHY[target]; };
  const verifySecurity = async () => { if (systemSettings.security?.ipCheckEnabled && systemSettings.security?.allowedIP) { setLocLoading(true); const currentIP = await getClientIP(); setLocLoading(false); if (!currentIP || currentIP !== systemSettings.security.allowedIP) { setErrorMsg("Mağaza ağında değilsiniz!"); return false; } } return true; };

  const handleLogin = (e) => { e.preventDefault(); setErrorMsg(''); const found = users.find(u => u.code === loginCode && u.pass === loginPass); if (found) { if (found.role === ROLES.DEFAULT) { setErrorMsg('Bu hesap Pasif.'); return; } if (systemSettings.maintenanceMode && found.role !== ROLES.FOUNDER) { setErrorMsg("Sistem bakımda."); return; } if (loginTab === 'admin') { if ([ROLES.FOUNDER, ROLES.MANAGER, ROLES.ASST_MANAGER].includes(found.role)) { if (systemSettings.permissions?.[found.role]?.canAccessPanel || found.role === ROLES.FOUNDER) { setAppUser(found); setLoginCode(''); setLoginPass(''); setView('admin'); setAdminTab('dashboard'); } else { setErrorMsg('Yetkisiz.'); } } else { setErrorMsg('Yetkisiz giriş.'); } } else { if ([ROLES.FOUNDER, ROLES.MANAGER].includes(found.role)) { setErrorMsg('Yönetici girişini kullanın.'); } else if (found.role === ROLES.OBSERVER) { setAppUser(found); setLoginCode(''); setLoginPass(''); setView('observer'); } else { if (systemSettings.security?.storePassword) { setPendingUser(found); setShowStoreAuthModal(true); } else { setAppUser(found); setLoginCode(''); setLoginPass(''); setView('staff'); } } } } else { setErrorMsg('Hatalı giriş!'); } };
  const finalizeStaffLogin = () => { if (qrInput === systemSettings.security.storePassword) { setAppUser(pendingUser); setLoginCode(''); setLoginPass(''); setPendingUser(null); setShowStoreAuthModal(false); setQrInput(''); setView('staff'); } else { alert("Hatalı Şifre!"); } };
  const updateSettings = async (newSettings) => { const updated = { ...systemSettings, ...newSettings }; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'systemSettings', 'main'), updated); };
  const updatePermission = async (r, k, v) => { const newPerms = { ...systemSettings.permissions, [r]: { ...systemSettings.permissions[r], [k]: v } }; await updateSettings({ permissions: newPerms }); };
  const setStoreIP = async () => { setLocLoading(true); const ip = await getClientIP(); if (ip) { await updateSettings({ security: { ...systemSettings.security, allowedIP: ip } }); setSuccessMsg(`IP: ${ip} kaydedildi.`); } else setErrorMsg("IP alınamadı."); setLocLoading(false); }
  const startBreak = async (bt, isLavabo=false) => { if (!(await verifySecurity())) return; const isExtra = bt && bt.id === 'extra'; if (!isLavabo && !isExtra) { const busy = activeBreaks.find(b => b.userDept === appUser.dept && b.userId !== appUser.id && !b.isLavabo && b.typeId !== 'extra'); if (busy) { setErrorMsg(`${busy.userName} molada.`); return; } const used = getTodayUsage(appUser.id, bt.id); if (used >= bt.duration) { setErrorMsg('Süre doldu.'); return; } } if (isExtra) { try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', appUser.id), { dailyExtraTime: 0 }); } catch(e) { console.error(e); } } try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'activeBreaks'), { userId: appUser.id, userName: appUser.name, userDept: appUser.dept, typeId: isLavabo ? 'lavabo' : (isExtra ? 'extra' : bt.id), typeLabel: isLavabo ? 'Lavabo' : (isExtra ? 'Ekstra Mola' : bt.label), expectedDuration: isLavabo ? 999 : (isExtra ? bt.duration : bt.duration), startTime: serverTimestamp(), isLavabo }); } catch(e){setErrorMsg(e.message)} };
  const endBreak = async () => { if (!(await verifySecurity())) return; const myBreak = activeBreaks.find(b => b.userId === appUser.id); if (myBreak) { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'breakHistory'), { ...myBreak, endTime: serverTimestamp() }); await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'activeBreaks', myBreak.id)); } };
  const handleSaveUser = async (e) => { e.preventDefault(); if (users.some(u => u.code === newUser.code && u.id !== editingUserId)) { setErrorMsg('Kod kullanımda'); return; } try { if (editingUserId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', editingUserId), newUser); else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), { ...newUser, status: 'active' }); setSuccessMsg('Kaydedildi'); setNewUser({name:'', code:'', pass:'', dept:DEPARTMENTS[0], role:ROLES.STAFF}); setEditingUserId(null); } catch(e){setErrorMsg(e.message)} };
  const deleteHistoryItem = async (i) => { if (!hasPermission(appUser.role, 'canDeleteBreaks')) { setErrorMsg('Yetki yok.'); return; } if (window.confirm('Kayıt silinsin mi?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'breakHistory', i.id)); };
  const addExtraTime = async () => { if (!extraTimeModal.userId || !manualExtraTime) return; try { const todayStr = new Date().toISOString().split('T')[0]; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', extraTimeModal.userId), { dailyExtraTime: parseInt(manualExtraTime), dailyExtraTimeDate: todayStr }); setSuccessMsg('Süre eklendi'); setExtraTimeModal({ show: false, userId: null, userName: '' }); setManualExtraTime(''); } catch(e) { setErrorMsg(e.message); } };
  const getTodayUsage = (uid, tid) => { const today = new Date(); today.setHours(0,0,0,0); return Math.floor(breakHistory.filter(h => h.userId === uid && h.typeId === tid && h.endTime && h.endTime.toDate() > today).reduce((acc, curr) => acc + getSecondsDiff(curr.startTime, curr.endTime), 0) / 60); };
  const groupedBreaks = { extra: activeBreaks.filter(b => b.typeId === 'extra').sort((a,b) => getSecondsDiff(b.startTime) - getSecondsDiff(a.startTime)), lavabo: activeBreaks.filter(b => b.isLavabo).sort((a,b) => getSecondsDiff(b.startTime) - getSecondsDiff(a.startTime)), yemek: activeBreaks.filter(b => b.typeId === 'yemek').sort((a,b) => getSecondsDiff(b.startTime) - getSecondsDiff(a.startTime)), cay: activeBreaks.filter(b => !b.isLavabo && b.typeId !== 'yemek' && b.typeId !== 'extra').sort((a,b) => getSecondsDiff(b.startTime) - getSecondsDiff(a.startTime)) };
  const renderLiveCard = (b, index) => { const sec = getSecondsDiff(b.startTime?.toDate?b.startTime.toDate():new Date(b.startTime), currentTime); const min = Math.floor(sec / 60); let cardClass = CARD_COLORS[index % CARD_COLORS.length]; if (b.isLavabo) { if (min >= 10) cardClass = "bg-red-600 border-red-500 animate-pulse"; } else if (min > b.expectedDuration) cardClass = "bg-red-600 border-red-500 animate-pulse"; return ( <div key={b.id} className={`${cardClass} p-4 rounded-xl border-2 shadow-lg flex justify-between items-center`}><div><h3 className="font-bold text-lg text-white">{b.userName}</h3><div className="text-xs text-white/80">{b.userDept}</div></div><div className="text-right"><div className="text-3xl font-mono font-bold text-white">{formatDuration(sec)}</div></div></div> ) };
  const togglePasswordVisibility = (id) => { setVisiblePasswords(prev => ({ ...prev, [id]: !prev[id] })); };
  const currentTheme = THEME_CATALOG.find(t => t.id === systemSettings.theme) || THEME_CATALOG[0];

  if (view === 'login') {
    return ( <div className="min-h-screen flex items-center justify-center p-4 font-sans relative overflow-hidden bg-black"> <div className={`absolute inset-0 opacity-50 bg-cover bg-center`} style={{backgroundImage:`url('${specialTheme.bg}')`}}></div> <div className={`absolute inset-0 ${specialTheme.overlay} backdrop-blur-sm`}></div> {showStoreAuthModal && ( <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-sm"> <div className="bg-slate-800 p-8 rounded-3xl border border-slate-600 shadow-2xl w-full max-w-sm text-center"> <QrCode className="w-16 h-16 text-white mx-auto mb-4"/> <h3 className="text-2xl font-bold text-white mb-2">Mağaza Doğrulaması</h3> {scanning ? ( <div className="mb-4 relative rounded-xl overflow-hidden border-2 border-green-500"> <video ref={videoRef} className="w-full h-48 object-cover"></video> <button onClick={stopScanning} className="absolute top-2 right-2 bg-red-600 p-1 rounded-full text-white"><X size={16}/></button> </div> ) : ( <button onClick={startScanning} className="w-full bg-slate-700 text-white p-3 rounded-xl mb-4 flex items-center justify-center hover:bg-slate-600 transition"><Scan className="mr-2"/> QR Kod Tara</button> )} <input type="text" value={qrInput} onChange={e=>setQrInput(e.target.value)} className="w-full bg-black/40 border border-white/20 rounded-xl p-4 text-white text-center text-xl font-bold tracking-widest mb-6" placeholder="ŞİFRE" /> <div className="flex gap-3"> <button onClick={()=>{setShowStoreAuthModal(false); setQrInput(''); setPendingUser(null); stopScanning();}} className="flex-1 p-4 bg-slate-700 text-white rounded-xl font-bold">İptal</button> <button onClick={finalizeStaffLogin} className="flex-1 p-4 bg-blue-600 text-white rounded-xl font-bold">Giriş</button> </div> </div> </div> )} <div className="bg-white/10 backdrop-blur-xl p-8 rounded-3xl shadow-2xl w-full max-w-md border border-white/20 relative z-10"> {systemSettings.maintenanceMode && <div className="mb-6 bg-yellow-500/20 border border-yellow-500 text-yellow-200 p-4 rounded-xl text-center flex items-center justify-center"><Construction className="mr-2"/><span className="font-bold">SİSTEM BAKIMDA</span></div>} <div className="text-center mb-6"><h1 className="text-3xl font-bold text-white">{specialTheme.title}</h1></div> <div className="flex bg-black/30 p-1 rounded-xl mb-6"> <button onClick={()=>setLoginTab('staff')} className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition ${loginTab==='staff' ? 'bg-blue-600 text-white shadow-lg' : 'text-white/50 hover:text-white'}`}>Personel Girişi</button> <button onClick={()=>setLoginTab('admin')} className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition ${loginTab==='admin' ? 'bg-purple-600 text-white shadow-lg' : 'text-white/50 hover:text-white'}`}>Yönetici Girişi</button> </div> <form onSubmit={handleLogin} className="space-y-5"> <div className="relative"><Users className="absolute left-4 top-3.5 text-blue-200 w-5 h-5"/><input type="text" value={loginCode} onChange={e=>setLoginCode(e.target.value)} className="w-full pl-12 p-3.5 bg-black/40 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder={loginTab==='staff'?'Personel Kodu':'Yönetici Kodu'} /></div> <div className="relative"> <Lock className="absolute left-4 top-3.5 text-blue-200 w-5 h-5"/> <input type={showLoginPass ? "text" : "password"} value={loginPass} onChange={e=>setLoginPass(e.target.value)} className="w-full pl-12 pr-10 p-3.5 bg-black/40 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Şifre" /> <button type="button" onClick={()=>setShowLoginPass(!showLoginPass)} className="absolute right-4 top-3.5 text-white/50 hover:text-white transition">{showLoginPass ? <EyeOff size={18}/> : <Eye size={18}/>}</button> </div> {errorMsg && <div className="text-red-300 text-sm font-bold bg-red-900/50 p-3 rounded-xl flex items-center"><AlertTriangle className="w-4 h-4 mr-2"/>{errorMsg}</div>} <button className={`w-full font-bold p-4 rounded-xl shadow-lg transition transform active:scale-95 ${loginTab==='staff' ? 'bg-blue-600 hover:bg-blue-500' : 'bg-purple-600 hover:bg-purple-500'} text-white`}>{loginTab==='staff'?'PERSONEL GİRİŞİ YAP':'YÖNETİCİ GİRİŞİ YAP'}</button> </form> {users.length===0 && <button onClick={async()=>{await addDoc(collection(db,'artifacts',appId,'public','data','users'),{name:'Admin',code:'admin',pass:'admin',dept:'Yönetim',role:ROLES.FOUNDER,status:'active'});alert('admin/admin')}} className="mt-8 text-xs text-white/30 hover:text-white underline w-full text-center block">Sistemi Kur</button>} </div> </div> );
  }

  if (view === 'observer') return ( <div className="min-h-screen bg-black text-white p-4 flex flex-col font-sans"> <header className="flex justify-between items-center mb-6 border-b border-gray-800 pb-4"><div className="flex items-center gap-3"><Eye className="text-green-500 w-8 h-8"/><h1 className="text-3xl font-bold">CANLI TAKİP</h1></div><div className="text-right"><div className="text-4xl font-mono font-bold text-green-500">{formatTime(currentTime)}</div><button onClick={()=>{setAppUser(null);setView('login')}} className="text-xs text-gray-600 hover:text-gray-400 mt-2">Çıkış</button></div></header> <div className="flex-1 flex flex-col gap-6 overflow-y-auto"> {groupedBreaks.extra.length > 0 && (<div className="bg-purple-900/20 p-6 rounded-2xl border border-purple-500/30"><h3 className="text-2xl font-bold text-purple-400 mb-4">YÖNETİCİ MOLA ({groupedBreaks.extra.length})</h3><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{groupedBreaks.extra.map((b,i)=>renderLiveCard(b,i))}</div></div>)} <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 content-start">{['yemek', 'cay', 'lavabo'].map(k => (<div key={k} className="bg-gray-900/50 p-4 rounded-2xl border border-gray-800"><h3 className="text-xl font-bold mb-4 uppercase text-white/80">{k} ({groupedBreaks[k].length})</h3><div className="space-y-3">{groupedBreaks[k].length===0?<p className="text-gray-600 italic">Boş</p>:groupedBreaks[k].map((b,i)=>renderLiveCard(b,i))}</div></div>))}</div> </div> </div> );

  if (view === 'staff' && appUser) {
    const myActiveBreak = activeBreaks.find(b => b.userId === appUser.id);
    const hasExtraTime = appUser.dailyExtraTime > 0;
    return ( <div className="min-h-screen flex flex-col relative bg-black"> <div className="absolute inset-0 bg-cover bg-center" style={{backgroundImage: `url('${staffTheme.bg}')`}}></div><div className="absolute inset-0 bg-black/40 backdrop-blur-[2px]"></div> <header className="bg-white/10 backdrop-blur-md border-b border-white/10 p-4 flex justify-between items-center m-4 rounded-2xl relative z-10 shadow-xl"><div><div className="font-bold text-white text-xl">{appUser.name}</div><div className="text-xs text-blue-200 font-medium uppercase">{appUser.dept}</div></div><button onClick={()=>{setAppUser(null);setView('login')}} className="bg-red-500/20 hover:bg-red-500/40 p-2 rounded-full text-red-200 transition"><LogOut/></button></header> <main className="flex-1 p-4 max-w-md mx-auto w-full space-y-6 relative z-10 flex flex-col justify-center"> {errorMsg && <div className="bg-red-500/90 text-white p-4 rounded-xl text-center font-bold shadow-xl">{errorMsg}</div>} {myActiveBreak ? ( <div className="bg-white/10 backdrop-blur-xl border border-white/20 rounded-3xl shadow-2xl p-8 text-center"> <div className={`inline-flex p-6 rounded-full mb-6 ${myActiveBreak.isLavabo?'bg-cyan-500':'bg-orange-500'} text-white`}>{myActiveBreak.isLavabo?<Droplets size={48}/>:<Coffee size={48}/>}</div><h2 className="text-3xl font-bold text-white mb-2">{myActiveBreak.typeLabel}</h2><div className="text-6xl font-mono font-bold text-white mb-8">{formatDuration(getSecondsDiff(myActiveBreak.startTime, currentTime))}</div><button onClick={endBreak} className="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-5 rounded-2xl text-xl">MOLAYI BİTİR</button> </div> ) : ( <div className="space-y-3"> {STANDARD_BREAKS.map(bt => { const used = getTodayUsage(appUser.id, bt.id); const rem = bt.duration-used; return ( <button key={bt.id} onClick={()=>startBreak(bt)} className="w-full p-4 rounded-2xl border border-white/10 shadow-lg flex justify-between items-center bg-white/10 hover:bg-white/20 text-white backdrop-blur-md"><div className="flex items-center"><div className={`p-3 rounded-xl mr-4 ${bt.id==='yemek'?'bg-orange-500':'bg-blue-500'} text-white`}>{bt.id==='yemek'?<Utensils size={20}/>:<Coffee size={20}/>}</div><div className="text-left"><div className="font-bold text-lg">{bt.label}</div><div className="text-xs text-white/60">Kullanılan: {used}dk / <span className="text-green-300 font-bold">Kalan: {Math.max(0, rem)}dk</span></div></div></div><div className="bg-white/10 p-2 rounded-full"><ToggleRight className="text-white"/></div></button> ) })} {hasExtraTime && <button onClick={()=>startBreak({id:'extra', label:'Ekstra Mola', duration:appUser.dailyExtraTime})} className="w-full p-4 rounded-2xl border-2 border-yellow-400/50 shadow-lg flex justify-between items-center bg-yellow-500/10 hover:bg-yellow-500/20 text-white backdrop-blur-md"><div className="flex items-center"><div className="p-3 rounded-xl mr-4 bg-yellow-500 text-white"><Star size={20}/></div><div className="text-left"><div className="font-bold text-lg text-yellow-200">EKSTRA MOLA</div><div className="text-xs text-white/60">Süre: {appUser.dailyExtraTime}dk</div></div></div><div className="bg-white/10 p-2 rounded-full"><ToggleRight className="text-yellow-400"/></div></button>} <button onClick={()=>startBreak(null,true)} className="w-full bg-cyan-900/40 backdrop-blur border border-cyan-500/30 text-cyan-100 p-5 rounded-2xl font-bold flex items-center justify-center mt-4"><Droplets className="mr-3 text-cyan-400"/> Lavabo Molası</button> </div> )} </main> </div> );
  }

  if (view === 'admin' && appUser) {
    const filteredUsers = users.filter(u => { if (staffFilterRole === 'active_only') return u.role !== ROLES.DEFAULT; if (staffFilterRole === 'default_only') return u.role === ROLES.DEFAULT; return true; });
    const sortedUsers = [...filteredUsers].sort((a, b) => (HIERARCHY[b.role] - HIERARCHY[a.role]) || a.name.localeCompare(b.name));
    const filteredHistory = breakHistory.filter(h => { const hDate = h.endTime ? (h.endTime.toDate ? h.endTime.toDate() : new Date(h.endTime)) : new Date(); if(filterStart && hDate<new Date(filterStart)) return false; if(filterEnd) {const end=new Date(filterEnd); end.setHours(23,59,59); if(hDate>end) return false;} if(filterName && !h.userName.toLowerCase().includes(filterName.toLowerCase())) return false; return true; });

    return ( <div className={`min-h-screen flex flex-col font-sans transition-colors ${currentTheme.class}`}> <nav className="bg-black/20 backdrop-blur-lg border-b border-white/5 sticky top-0 z-50"> <div className="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center"> <div className="flex items-center gap-4"><div className="font-bold text-lg">{appUser.name}</div></div> <div className="flex items-center bg-black/20 p-1 rounded-xl border border-white/5"> {[{id:'dashboard',icon:Activity,l:'Canlı'},{id:'staff',icon:UserCog,l:'Personel'},{id:'reports',icon:FileText,l:'Raporlar'},...(appUser.role===ROLES.FOUNDER?[{id:'settings',icon:Settings,l:'Ayarlar'}]:[])].map(t=>(<button key={t.id} onClick={()=>setAdminTab(t.id)} className={`flex items-center px-4 py-2 rounded-lg text-sm font-medium transition ${adminTab===t.id?'bg-white/10 text-white shadow':'text-white/50 hover:text-white'}`}><t.icon size={16} className="mr-2"/>{t.l}</button>))} </div> <button onClick={()=>{setAppUser(null);setView('login')}} className="text-red-400 hover:bg-red-500/10 p-3 rounded-xl transition ml-4"><LogOut size={20}/></button> </div> </nav> <main className="flex-1 max-w-7xl mx-auto w-full p-8 relative"> {extraTimeModal.show && <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm"><div className="bg-slate-800 p-6 rounded-2xl border border-slate-600 shadow-2xl w-full max-w-sm"><h3 className="text-xl font-bold text-white mb-4 flex items-center"><Timer className="mr-2 text-yellow-400"/> Ekstra Süre</h3><p className="text-slate-300 mb-4"><span className="font-bold text-white">{extraTimeModal.userName}</span></p><div className="mb-6"><input type="number" value={manualExtraTime} onChange={(e)=>setManualExtraTime(e.target.value)} className="w-full bg-black/30 border border-white/20 rounded-xl p-4 text-white text-center text-2xl font-mono" placeholder="Örn: 15" /></div><div className="flex gap-3"><button onClick={()=>{setExtraTimeModal({show:false,userId:null,userName:''}); setManualExtraTime('')}} className="flex-1 p-3 bg-slate-700 text-white rounded-xl font-bold">İptal</button><button onClick={addExtraTime} className="flex-1 p-3 bg-yellow-600 text-white rounded-xl font-bold">Tanımla</button></div></div></div>}
          {adminTab === 'dashboard' && ( <div className="space-y-6"> <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">{['yemek', 'cay', 'lavabo'].map(k => (<div key={k} className="bg-white/5 p-4 rounded-2xl border border-white/10"><h3 className="text-lg font-bold text-white/80 mb-4 uppercase">{k} ({groupedBreaks[k].length})</h3><div className="space-y-3">{groupedBreaks[k].length===0?<span className="text-white/30 italic">Boş</span>:groupedBreaks[k].map((b,i)=>renderLiveCard(b,i))}</div></div>))}</div> </div> )}
          {adminTab === 'staff' && ( <div className="space-y-6"> <div className="bg-white/5 rounded-2xl p-6 border border-white/10 shadow-lg"> <h3 className="font-bold text-lg text-white mb-6">{editingUserId ? 'Düzenle' : 'Yeni Ekle'}</h3> <form onSubmit={handleSaveUser} className="grid grid-cols-1 md:grid-cols-5 gap-4"> <div className="md:col-span-1"><label className="text-xs font-bold opacity-50 block mb-2">ROL</label><select value={newUser.role} onChange={e=>setNewUser({...newUser, role: e.target.value})} className="w-full bg-black/30 border border-white/20 rounded-lg p-2.5 text-white">{Object.entries(ROLE_LABELS).map(([k,v])=><option key={k} value={k} className="bg-slate-900">{v}</option>)}</select></div> <div className="md:col-span-1"><label className="text-xs font-bold opacity-50 block mb-2">KOD</label><input type="text" value={newUser.code} onChange={e=>setNewUser({...newUser, code: e.target.value})} className="w-full bg-black/30 border border-white/20 rounded-lg p-2.5 text-white" placeholder="1001"/></div> <div className="md:col-span-1"><label className="text-xs font-bold opacity-50 block mb-2">AD SOYAD</label><input type="text" value={newUser.name} onChange={e=>setNewUser({...newUser, name: e.target.value})} className="w-full bg-black/30 border border-white/20 rounded-lg p-2.5 text-white"/></div> <div className="md:col-span-1"><label className="text-xs font-bold opacity-50 block mb-2">BÖLÜM</label><select value={newUser.dept} onChange={e=>setNewUser({...newUser, dept: e.target.value})} className="w-full bg-black/30 border border-white/20 rounded-lg p-2.5 text-white">{DEPARTMENTS.map(d=><option key={d} value={d} className="bg-slate-900">{d}</option>)}<option value="Yönetim" className="bg-slate-900">Yönetim</option></select></div> <div className="md:col-span-1 flex items-end"><button className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold p-2.5 rounded-lg flex items-center justify-center">{editingUserId?<Save